# Brother QL-800/810W/820NWB ラスターコマンドリファレンス

このファイルは`cv_ql800_jpn_raster_101.pdf`から抽出した重要な仕様情報をまとめたものです。

## 概要

Brother P-Touch QLシリーズ（QL-800/810W/820NWB）用のラスターコマンド仕様書。プリンタードライバーを使用せずに直接プリンターを制御するための技術仕様。

## 印刷手順

1. ポートオープン（USB/シリアル/ネットワーク）
2. ステータス確認（ESC i S）
3. 印刷データ送信
4. 印刷実行
5. 印刷終了状況確認
6. ポートクローズ

## 印刷データ構造

### 1. 初期化コマンド（ジョブ先頭で1度のみ）
- 無効指令：400バイト分の無効指令（00h）
- 初期化：`1Bh 40h`

### 2. 制御コード（各ページ先頭）
1. 動的コマンドモード切替：`1Bh 69h 61h 01h`
2. ステータス自動通知モード切替：`1Bh 69h 21h 00h`
3. 印字情報指令：`1Bh 69h 7Ah ...`（用紙サイズ情報）
4. 各種モード設定：`1Bh 69h 4Dh 40h`（オートカット設定）
5. オートカット枚数指定：`1Bh 69h 41h 01h`
6. 拡張モード設定：`1Bh 69h 4Bh 08h`（カットアットエンド）
7. 余白量指定：`1Bh 69h 64h ...`
8. 圧縮モード選択：`4Dh 02h`（TIFF圧縮）

### 3. ラスターデータ
- ラスターグラフィックス転送：`g {s} {n} {data}`
- 2色ラスターグラフィックス転送：`w {c} {n1} {data}`
- ゼロラスターグラフィックス：`Z` (5Ah)

### 4. 印字指令
- 通常印字指令：`FF` (0Ch) - 最後以外のページ
- 排出付き印字指令：`Control-Z` (1Ah) - 最後のページ

## 解像度とメディアサイズ

### 解像度
- 通常：300dpi × 300dpi（縦横比1:1）
- 高解像度：600dpi × 300dpi（縦横比2:1）

### 長尺テープサイズ（主要なもの）
| テープ種類 | メディア幅 | 印刷可能領域幅 | 幅方向オフセット |
|-----------|------------|----------------|------------------|
| 12mm | 12.0mm (142 dots) | 9.0mm (106 dots) | 1.5mm (18 dots) |
| 29mm | 29.0mm (342 dots) | 25.9mm (306 dots) | 1.5mm (18 dots) |
| 38mm | 38.0mm (449 dots) | 35.0mm (413 dots) | 1.5mm (18 dots) |
| 50mm | 50.0mm (590 dots) | 46.9mm (554 dots) | 1.5mm (18 dots) |
| 54mm | 53.8mm (636 dots) | 50.0mm (590 dots) | 1.9mm (23 dots) |
| 62mm | 62.0mm (732 dots) | 58.9mm (696 dots) | 1.5mm (18 dots) |

### ダイカットラベル（主要なもの）
| ラベル種類 | 幅 | 長さ | 印刷可能領域幅 | 印刷可能領域長さ |
|-----------|-----|------|----------------|------------------|
| 17mm x 54mm | 17.0mm (201 dots) | 53.9mm (636 dots) | 14.0mm (165 dots) | 47.9mm (566 dots) |
| 29mm x 90mm | 29.0mm (342 dots) | 89.8mm (1061 dots) | 25.9mm (306 dots) | 83.9mm (991 dots) |
| 38mm x 90mm | 38.0mm (449 dots) | 89.8mm (1061 dots) | 35.0mm (413 dots) | 83.9mm (991 dots) |
| 62mm x 29mm | 62.0mm (732 dots) | 28.9mm (341 dots) | 58.9mm (696 dots) | 22.9mm (271 dots) |

## ラスターライン仕様

### 全ピン数：720ピン
- 1ラスターライン = 90バイト（720ピン ÷ 8ピン/バイト）
- ビット配置：MSBから順に印字（1=印字、0=非印字）

### テープ別ピン配置
| テープ | 左余白ピン数 | 印刷可能領域ピン数 | 右余白ピン数 | バイト数 |
|--------|-------------|------------------|--------------|----------|
| 12mm | 585 | 106 | 29 | 90 |
| 29mm | 408 | 306 | 6 | 90 |
| 38mm | 295 | 413 | 12 | 90 |
| 62mm | 12 | 696 | 12 | 90 |

## 主要コマンド詳細

### ステータス情報リクエスト（ESC i S）
- コマンド：`1B 69 53`
- 応答：32バイト固定長ステータス
- 機種識別、メディア情報、エラー状態等を含む

### 印字情報指令（ESC i z）
- コマンド：`1B 69 7A {10パラメーター}`
- 用紙種類、サイズ、ラスター数等を指定

### 圧縮モード（TIFF Pack Bits）
- 同一データ連続：個数-1を負数で指定 + データ1バイト
- 異なるデータ連続：個数-1を正数で指定 + 全データ
- 90バイト超過時は非圧縮として91バイト送信

## USB接続仕様

### USB仕様
- USB 1.1準拠
- ベンダーID：0x04F9
- 製品ID：
  - QL-800：0x209B
  - QL-810W：0x209C  
  - QL-820NWB：0x209D
- エンドポイント1：インバルク（ステータス受信）
- エンドポイント2：アウトバルク（コマンド/データ送信）
- 最大パケットサイズ：64バイト

### 通信フロー
1. 通常フロー：ステータス確認→データ送信→印刷→完了通知
2. エラーフロー：エラー検出→初期化→データ再送
3. クーリングフロー：高温時の印刷停止→冷却待ち→再開

## エラー情報

### エラー情報1
- Bit 0：印刷時メディア無し
- Bit 1：メディア終了（ダイカットのみ）
- Bit 2：カッタージャム
- Bit 4：本体ビジー（印刷中）
- Bit 5：パワーオフ

### エラー情報2
- Bit 0：メディア交換（違い）
- Bit 1：展開バッファーフル
- Bit 2：通信エラー
- Bit 4：印刷中カバーオープン
- Bit 6：用紙送り不能

## 制約・注意事項

1. 印刷データ送信後、印刷終了まで他コマンド送信禁止
2. USB非圧縮時は印字指令待たずに逐次印刷開始
3. 長尺ラベル（>1000mm）でUSBタイムアウト可能性
4. QL-800は圧縮モード非対応
5. 2色印刷時は186バイト（w 01 90 + w 02 90）で1ラスター
6. ダイカットでは余白量を0に設定必須

## フィード量制限

- 長尺テープ：最小3mm、最大127mm
- ダイカットラベル：固定（余白設定は0）

## 最大・最小長

- 長尺テープ：最小12.7mm、最大1000mm
- ダイカットラベル：固定サイズ

この仕様書は印刷制御の実装において重要な参考資料となります。